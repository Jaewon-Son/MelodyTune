/**
 * 1. 상수 및 설정 (Configuration)
 */
const CONFIG = {
  API_BASE_URL: "/api/stores",
  MARKER: {
    DEFAULT: null,
    HIGHLIGHT: {
      src: "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
      size: new kakao.maps.Size(30, 42),
    },
  },
};

const NAV_MENU_DATA = [
  { title: "기타", items: ["어쿠스틱 기타", "일렉 기타", "베이스 기타", "우쿨렐레"] },
  { title: "드럼", items: ["드럼", "전자드럼", "퍼커션"] },
  { title: "건반악기", items: ["피아노", "전자피아노", "신디사이저", "오르간"] },
  { title: "관현악기", items: ["바이올린", "첼로", "비올라", "플루트", "색소폰"] },
  { title: "음향장비", items: ["마이크", "오디오 인터페이스", "스피커"] },
];

const REGIONS_DATA = {
  서울특별시: {
    coords: { lat: 37.5665, lng: 126.9779 },
    gu: {
      종로구: { lat: 37.5729, lng: 126.9793 },
      강남구: { lat: 37.5172, lng: 127.0473 },
      서초구: { lat: 37.4835, lng: 127.0323 },
    },
  },
  경기도: {
    coords: { lat: 37.4138, lng: 127.5182 },
    gu: {
      수원시: { lat: 37.2636, lng: 127.0286 },
      성남시: { lat: 37.4232, lng: 127.1388 },
    },
  },
  충청남도: {
    coords: { lat: 36.6595, lng: 126.6735 },
    gu: { 천안시: { lat: 36.8151, lng: 127.1139 } },
  },
};

/**
 * 2. 상태 관리 (State Management)
 */
const AppState = {
  map: null,
  markers: [],
  currentRegion: null,
  filterInstruments: [],
  mapClickListener: null,
};

/**
 * 3. DOM 요소 캐싱 (DOM Selection)
 */
const DOM = {
  // 메인 UI
  map: document.getElementById("map"),
  navMenu: document.getElementById("navMenu"),
  regionBtn: document.getElementById("headerRegionBtn"),
  regionDropdown: document.getElementById("regionDropdown"),
  resultTitle: document.getElementById("resultTitle"),
  storeList: document.getElementById("storeList"),
  
  // 사용자 메뉴
  userMenu: document.querySelector(".user-menu"),

  // 리뷰 패널 관련
  reviewPanel: document.getElementById("review-panel"),
  reviewStoreName: document.getElementById("reviewStoreName"),
  closeReviewBtn: document.getElementById("closeReviewBtn"),
  avgRating: document.getElementById("avgRating"),
  totalReviews: document.getElementById("totalReviews"),
  aiSummary: document.getElementById("aiSummary"),
  reviewList: document.getElementById("reviewList"),

  // 상세(악기) 패널 관련 (추가됨)
  detailPanel: document.getElementById("store-detail-panel"),
  detailStoreName: document.getElementById("detail-store-name"),
  detailAddress: document.getElementById("detail-address"),
  detailPhone: document.getElementById("detail-phone"),
  detailHours: document.getElementById("detail-hours"),
  instrumentList: document.getElementById("instrument-list"),
  closeDetailBtn: document.getElementById("close-detail-panel"),

  // 모달(업체 등록) 관련
  registerBtn: document.getElementById("registerStoreBtn"),
  modalOverlay: document.getElementById("modalOverlay"),
  modalWrap: document.getElementById("modalWrap"),
  closeModalBtn: document.querySelector("#modalWrap button[onclick='hideModal()']"),

  // 폼 관련
  form: {
    name: document.getElementById("storeName"),
    region: document.getElementById("storeRegion"),
    lat: document.getElementById("storeLat"),
    lng: document.getElementById("storeLng"),
    instruments: document.getElementById("storeInstruments"),
    submitBtn: document.getElementById("submitStore"),
    mapSelectBtn: document.getElementById("selectFromMapBtn"),
  },
};

/**
 * 4. 서비스 로직 (Service Layer)
 * - MapManager: 지도 관련 로직
 * - APIService: 백엔드 API 호출 로직
 */
const MapManager = {
  init() {
    AppState.map = new kakao.maps.Map(DOM.map, {
      center: new kakao.maps.LatLng(36.5, 127.8),
      level: 13,
    });
  },

  move(lat, lng, level = null) {
    const moveLatLon = new kakao.maps.LatLng(lat, lng);
    AppState.map.panTo(moveLatLon);
    if (level) AppState.map.setLevel(level);
  },

  clearMarkers() {
    AppState.markers.forEach((m) => m.setMap(null));
    AppState.markers = [];
  },

  addMarker(lat, lng, title) {
    const marker = new kakao.maps.Marker({
      position: new kakao.maps.LatLng(lat, lng),
      title: title,
      map: AppState.map,
    });
    AppState.markers.push(marker);
    return marker; // 이벤트 등록을 위해 마커 객체 반환
  },

  highlightMarker(index) {
    const highlightImage = new kakao.maps.MarkerImage(
      CONFIG.MARKER.HIGHLIGHT.src,
      CONFIG.MARKER.HIGHLIGHT.size
    );
    AppState.markers.forEach((m) => m.setImage(null));
    if (AppState.markers[index]) {
      AppState.markers[index].setImage(highlightImage);
    }
  },
};

const APIService = {
  async checkSession() {
    try {
      const response = await fetch("/api/auth/me");
      if (response.ok) return await response.json();
      return null;
    } catch (e) { return null; }
  },

  async logout() {
    await fetch("/api/auth/logout", { method: "POST" });
    location.reload();
  },

  async fetchStores(region, instruments) {
    const params = new URLSearchParams();
    if (region) params.append("region", region);
    if (instruments.length === 1) params.append("instrument", instruments[0]);

    const url = `${CONFIG.API_BASE_URL}?${params.toString()}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error("API Fetch Error");
    return await response.json();
  },

  async registerStore(storeData) {
    const response = await fetch(CONFIG.API_BASE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(storeData),
    });
    if (!response.ok) throw new Error("API Register Error");
    return response;
  },

  async fetchStoreReviews(storeId) {
    const url = `/api/stores/${storeId}/reviews`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`리뷰 로딩 실패 (ID: ${storeId})`);
    return await response.json();
  },
};

/**
 * 5. UI 매니저 (UI Logic)
 * - 화면 렌더링 및 UI 컴포넌트 제어
 */
const UIManager = {
  // [메뉴] 네비게이션 및 드롭다운 생성
  createMenu(targetEl, dataList, options) {
    dataList.forEach((group) => {
      let container = targetEl;
      if (options.wrapperClass) {
        const wrapper = document.createElement("div");
        wrapper.className = options.wrapperClass;
        targetEl.appendChild(wrapper);
        container = wrapper;
      }

      const titleEl = document.createElement(options.titleTag || "div");
      titleEl.className = options.titleClass;
      titleEl.textContent = group.title;
      titleEl.addEventListener("click", (e) => {
        e.stopPropagation();
        if (options.onTitleClick) options.onTitleClick(group, e.target);
      });

      const listContainer = document.createElement("div");
      listContainer.className = options.listClass;

      group.items.forEach((item) => {
        const itemEl = document.createElement(options.itemTag || "div");
        itemEl.className = options.itemClass;
        itemEl.textContent = item;
        itemEl.addEventListener("click", (e) => {
          e.stopPropagation();
          if (options.onItemClick) options.onItemClick(item, group);
        });
        listContainer.appendChild(itemEl);
      });

      container.appendChild(titleEl);
      container.appendChild(listContainer);
    });
  },

  toggleRegionDropdown(show) {
    DOM.regionDropdown.style.display = show ? "block" : "none";
  },

  // [목록] 검색 결과 렌더링
  renderStoreList(stores) {
    DOM.storeList.innerHTML = "";
    UIManager.reviewPanel.hide();
    UIManager.detailPanel.hide(); // 검색 시 상세 패널도 숨김

    if (!stores || stores.length === 0) {
      DOM.storeList.innerHTML = '<p class="result-placeholder">조건에 맞는 악기점이 없습니다.</p>';
      return;
    }

    stores.forEach((store, index) => {
      const item = document.createElement("div");
      item.className = "store-item";
      item.innerHTML = `<h4>${store.name}</h4><p>${store.region} | ${store.instruments.join(", ")}</p>`;
      
      // 목록 클릭 시 공통 로직 실행
      item.addEventListener("click", () => Controller.handleStoreClick(store, index));
      DOM.storeList.appendChild(item);
    });
  },

  // [패널] 리뷰 패널 제어
  reviewPanel: {
    async show(store) {
      DOM.reviewPanel.style.display = "flex";
      DOM.reviewStoreName.textContent = store.name;
      DOM.reviewList.innerHTML = '<p class="review-placeholder">데이터를 불러오는 중...</p>';
      DOM.avgRating.textContent = "";
      DOM.totalReviews.textContent = "";
      DOM.aiSummary.innerHTML = "";

      try {
        const data = await APIService.fetchStoreReviews(store.id);
        DOM.avgRating.textContent = `⭐ ${data.averageRating.toFixed(1)}`;
        DOM.totalReviews.textContent = `(${data.totalReviews}개 리뷰)`;
        
        if (data.aiSummary && data.aiSummary.length > 0) {
          DOM.aiSummary.innerHTML = `**AI 리뷰 요약:** ${data.aiSummary.join(" | ")}`;
        } else {
          DOM.aiSummary.innerHTML = `**AI 리뷰 요약:** 요약 데이터가 없습니다.`;
        }

        UIManager.renderReviews(data.reviews);
      } catch (error) {
        console.error(error);
        DOM.reviewList.innerHTML = '<p class="review-placeholder" style="color:red;">리뷰를 불러오는 데 실패했습니다.</p>';
      }
    },
    hide() { DOM.reviewPanel.style.display = "none"; },
  },

  renderReviews(reviews) {
    DOM.reviewList.innerHTML = "";
    if (!reviews || reviews.length === 0) {
      DOM.reviewList.innerHTML = '<p class="review-placeholder">아직 등록된 리뷰가 없습니다.</p>';
      return;
    }
    reviews.forEach((review) => {
      const item = document.createElement("div");
      item.className = "review-item";
      const formattedDate = new Date(review.createdAt).toISOString().split("T")[0];
      item.innerHTML = `
        <p class="review-meta"><span style="color:#ffc107; font-weight:bold;">⭐ ${review.rating.toFixed(1)}</span> | ${review.userName}님 | ${formattedDate}</p>
        <p class="review-text">${review.content}</p>
      `;
      DOM.reviewList.appendChild(item);
    });
  },

  // [패널] 매장 상세(악기) 패널 제어
  detailPanel: {
    show(store) {
      DOM.detailPanel.style.display = "flex";
      DOM.detailStoreName.innerText = store.name;
      // [임시] 정적 데이터 (추후 API에서 받아온 store 객체 활용)
      DOM.detailAddress.innerText = "충남 천안시 동남구 신부동 123-45";
      DOM.detailPhone.innerText = "010-1234-5678";
      DOM.detailHours.innerHTML = `11:00 ~ 21:00 <span class="closed-day">(매주 화요일 휴무)</span>`;

      // [임시] 더미 악기 데이터
      const dummyInstruments = [
        { name: "마크 제임스 Standard Classic", price: "518,000원", img: "https://via.placeholder.com/150?text=Guitar1" },
        { name: "[리퍼] 헥스 기타 H100 LITE", price: "228,650원", img: "https://via.placeholder.com/150?text=Guitar2" },
        { name: "[리퍼] 헥스 기타 H300 SG/BK", price: "425,000원", img: "https://via.placeholder.com/150?text=Guitar3" },
        { name: "[입문] 고퍼우드 Gopherwood", price: "471,700원", img: "https://via.placeholder.com/150?text=Guitar4" },
        { name: "야마하 퍼시피카 112J", price: "380,000원", img: "https://via.placeholder.com/150?text=Guitar5" },
      ];

      DOM.instrumentList.innerHTML = '';
      dummyInstruments.forEach(inst => {
        const itemHtml = `
            <div class="instrument-item">
                <div class="instrument-img-box"><img src="${inst.img}" alt="${inst.name}"></div>
                <div class="inst-info">
                    <p class="inst-name">${inst.name}</p>
                    <p class="inst-price">${inst.price}</p>
                </div>
            </div>`;
        DOM.instrumentList.insertAdjacentHTML('beforeend', itemHtml);
      });
    },
    hide() { DOM.detailPanel.style.display = 'none'; }
  },

  // [모달] 업체 등록 모달 제어
  modal: {
    show() {
      DOM.modalOverlay.style.display = "block";
      DOM.modalWrap.style.display = "block";
    },
    hide() {
      DOM.modalOverlay.style.display = "none";
      DOM.modalWrap.style.display = "none";
    },
    resetForm() {
      DOM.form.name.value = "";
      DOM.form.lat.value = "";
      DOM.form.lng.value = "";
      DOM.form.instruments.value = "";
    },
  },

  populateFormRegionOptions() {
    Object.keys(REGIONS_DATA).forEach((city) => {
      const group = document.createElement("optgroup");
      group.label = city;
      Object.keys(REGIONS_DATA[city].gu).forEach((gu) => {
        const opt = document.createElement("option");
        opt.value = gu;
        opt.textContent = gu;
        group.appendChild(opt);
      });
      DOM.form.region.appendChild(group);
    });
  },

  updateAuthUI(user) {
    if (user) {
      DOM.userMenu.innerHTML = `<span style="color:#333; font-weight:bold;">${user.name}님</span><span onclick="APIService.logout()">로그아웃</span><span>마이페이지</span>`;
      DOM.registerBtn.style.display = (user.role === "BUSINESS") ? "block" : "none";
    } else {
      DOM.userMenu.innerHTML = `<span onclick="location.href='login.html'">로그인</span><span onclick="location.href='signup.html'">회원가입</span>`;
      DOM.registerBtn.style.display = "none";
    }
  },
};

/**
 * 6. 컨트롤러 (Controller / Business Logic)
 * - 전체적인 흐름 제어, 이벤트 핸들러 모음
 */
const Controller = {
  // 매장 클릭 핸들러 (목록 클릭 & 지도 마커 클릭 공용)
  handleStoreClick(store, index) {
    // 1. 지도 이동 및 하이라이트
    MapManager.move(store.lat, store.lng, 4);
    MapManager.highlightMarker(index);

    // 2. 패널 열기
    UIManager.reviewPanel.show(store);
    UIManager.detailPanel.show(store);
  },

  async executeSearch() {
    MapManager.clearMarkers();
    DOM.storeList.innerHTML = '<p class="result-placeholder">데이터를 불러오는 중...</p>';

    try {
      const data = await APIService.fetchStores(AppState.currentRegion, AppState.filterInstruments);

      // 클라이언트 사이드 필터링
      const results = data.filter((store) => {
        if (AppState.filterInstruments.length > 0) {
          return store.instruments.some((inst) => AppState.filterInstruments.includes(inst));
        }
        return true;
      });

      // 마커 생성 및 클릭 이벤트 등록
      results.forEach((store, index) => {
        const marker = MapManager.addMarker(store.lat, store.lng, store.name);
        kakao.maps.event.addListener(marker, 'click', () => Controller.handleStoreClick(store, index));
      });

      UIManager.renderStoreList(results);
    } catch (error) {
      console.error(error);
      DOM.storeList.innerHTML = '<p class="result-placeholder" style="color:red;">서버 연결 실패</p>';
    }
  },

  handleRegionSelect(guName, coords) {
    AppState.currentRegion = guName;
    DOM.regionBtn.innerHTML = `${guName} <span>▼</span>`;
    MapManager.move(coords.lat, coords.lng, 7);
    Controller.executeSearch();
  },

  async initApp() {
    MapManager.init();
    
    // Auth & UI Setup
    const user = await APIService.checkSession();
    UIManager.updateAuthUI(user);
    UIManager.populateFormRegionOptions();

    // Nav Menu Setup
    UIManager.createMenu(DOM.navMenu, NAV_MENU_DATA, {
      wrapperClass: "nav-group", titleClass: "nav-title", listClass: "nav-dropdown", itemClass: "nav-item",
      onTitleClick: (group) => {
        DOM.resultTitle.innerText = `${group.title} 전문점 검색`;
        AppState.filterInstruments = group.items;
        Controller.executeSearch();
      },
      onItemClick: (item) => {
        DOM.resultTitle.innerText = `${item} 전문점 검색`;
        AppState.filterInstruments = [item];
        Controller.executeSearch();
      },
    });

    // Region Dropdown Setup
    const regionListData = Object.keys(REGIONS_DATA).map((city) => ({
      title: city, items: Object.keys(REGIONS_DATA[city].gu),
    }));
    UIManager.createMenu(DOM.regionDropdown, regionListData, {
      titleTag: "button", titleClass: "region-group-btn", listClass: "gu-list-container", itemTag: "button", itemClass: "gu-btn",
      onTitleClick: (group, el) => {
        const listDiv = el.nextElementSibling;
        listDiv.style.display = listDiv.style.display === "block" ? "none" : "block";
      },
      onItemClick: (guName, group) => {
        const coords = REGIONS_DATA[group.title].gu[guName];
        Controller.handleRegionSelect(guName, coords);
        UIManager.toggleRegionDropdown(false);
      },
    });

    // Event Bindings
    DOM.regionBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      UIManager.toggleRegionDropdown(DOM.regionDropdown.style.display !== "block");
    });
    window.addEventListener("click", () => UIManager.toggleRegionDropdown(false));

    DOM.closeReviewBtn.addEventListener("click", UIManager.reviewPanel.hide);
    DOM.closeDetailBtn.addEventListener("click", UIManager.detailPanel.hide);

    DOM.registerBtn.addEventListener("click", UIManager.modal.show);
    DOM.modalOverlay.addEventListener("click", UIManager.modal.hide);
    if (DOM.closeModalBtn) DOM.closeModalBtn.onclick = UIManager.modal.hide;

    // 위치 선택 (모달)
    DOM.form.mapSelectBtn.addEventListener("click", () => {
      UIManager.modal.hide();
      alert("지도에서 위치를 클릭해주세요.");
      
      if (AppState.mapClickListener) kakao.maps.event.removeListener(AppState.map, "click", AppState.mapClickListener);
      
      AppState.mapClickListener = function (mouseEvent) {
        const latlng = mouseEvent.latLng;
        DOM.form.lat.value = latlng.getLat().toFixed(6);
        DOM.form.lng.value = latlng.getLng().toFixed(6);
        UIManager.modal.show();
        kakao.maps.event.removeListener(AppState.map, "click", AppState.mapClickListener);
      };
      kakao.maps.event.addListener(AppState.map, "click", AppState.mapClickListener);
    });

    // 등록 제출
    DOM.form.submitBtn.addEventListener("click", () => {
      const name = DOM.form.name.value.trim();
      const region = DOM.form.region.value;
      const lat = parseFloat(DOM.form.lat.value);
      const lng = parseFloat(DOM.form.lng.value);
      const instStr = DOM.form.instruments.value;

      if (!name || !region || isNaN(lat) || isNaN(lng)) {
        alert("모든 정보를 입력해주세요.");
        return;
      }
      const storeData = {
        name, region, lat, lng,
        instruments: instStr.split(",").map((s) => s.trim()).filter((s) => s !== ""),
      };
      APIService.registerStore(storeData)
        .then(() => {
          alert("등록되었습니다!");
          UIManager.modal.hide();
          UIManager.modal.resetForm();
          Controller.executeSearch();
        })
        .catch(() => alert("서버 연결 실패"));
    });

    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => MapManager.move(pos.coords.latitude, pos.coords.longitude, 6),
        () => console.warn("GPS 권한 없음")
      );
    }
  },
};

// Start App
Controller.initApp();