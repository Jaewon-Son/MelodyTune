<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>매장 관리 - Melody Tune</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #f5f5f5; overflow: auto; }
        .manage-container {
            max-width: 900px; margin: 40px auto; background: white;
            padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .page-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #333; }
        
        .status-box {
            padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee;
            text-align: left; margin-bottom: 30px; border-left: 5px solid #42d29e;
        }
        
        /* 그리드 레이아웃 (등록 폼 + 목록) */
        .manage-content { display: none; gap: 30px; }
        .manage-content.active { display: flex; flex-direction: column; }
        
        /* 상품 등록 폼 */
        .form-section { background: #fff; border: 1px solid #eee; padding: 20px; border-radius: 8px; }
        .form-section h3 { margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .btn-primary {
            background: #42d29e; color: white; padding: 12px; border-radius: 5px;
            font-weight: bold; font-size: 16px; width: 100%; border: none; cursor: pointer;
        }
        .btn-primary:hover { background: #33b585; }
        .preview-img { width: 100px; height: 100px; object-fit: cover; margin-top: 10px; border-radius: 5px; display: none; border: 1px solid #ddd; }

        /* 상품 목록 테이블 */
        .list-section { margin-top: 20px; }
        .list-section h3 { margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f1f1f1; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .prod-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .btn-delete {
            background: #ff6b6b; color: white; border: none; padding: 5px 10px; 
            border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        .btn-delete:hover { background: #fa5252; }
        
        .empty-msg { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.href='main.html'" style="cursor: pointer;">Melody Tune</div>
        <div class="user-menu">
            <span onclick="location.href='main.html'">메인으로 돌아가기</span>
        </div>
    </header>

    <div class="manage-container">
        <h2 class="page-title">매장 관리</h2>

        <div id="storeStatusBox" class="status-box">
            <p>매장 정보를 불러오는 중...</p>
        </div>

        <div id="manageContent" class="manage-content">
            
            <div class="form-section">
                <h3>새 상품 등록</h3>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label>상품 이름</label>
                            <input type="text" id="prodName" placeholder="예: 야마하 퍼시피카">
                        </div>
                        <div class="form-group">
                            <label>가격 (원)</label>
                            <input type="number" id="prodPrice" placeholder="숫자만 입력">
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <div class="form-group">
                            <label>상품 이미지</label>
                            <input type="file" id="prodImage" accept="image/*">
                            <img id="imgPreview" class="preview-img" alt="미리보기">
                        </div>
                    </div>
                </div>
                <button class="btn-primary" onclick="submitProduct()">상품 등록하기</button>
            </div>

            <div class="list-section">
                <h3>등록된 상품 목록</h3>
                <table id="productTable">
                    <thead>
                        <tr>
                            <th style="width: 80px;">이미지</th>
                            <th>상품명</th>
                            <th style="width: 120px;">가격</th>
                            <th style="width: 80px;">관리</th>
                        </tr>
                    </thead>
                    <tbody id="productListBody">
                        </tbody>
                </table>
            </div>

        </div>
    </div>

    <script>
        let myStoreId = null;

        // 1. 초기화: 내 매장 정보 및 상품 목록 가져오기
        async function initManage() {
            try {
                // 내 매장 ID 조회
                const response = await fetch('/api/my-store');
                const statusBox = document.getElementById('storeStatusBox');
                const contentDiv = document.getElementById('manageContent');

                if (response.status === 204) {
                    statusBox.innerHTML = `<p>등록된 매장이 없습니다. 메인 페이지에서 매장을 먼저 등록해주세요.</p>`;
                    statusBox.style.borderLeft = '5px solid #ccc';
                    return;
                }
                
                if (!response.ok) {
                    alert('로그인이 필요합니다.');
                    location.href = 'login.html';
                    return;
                }

                const store = await response.json();
                myStoreId = store.id;

                // 매장 정보 표시
                statusBox.innerHTML = `
                    <h3 style="margin:0 0 5px 0;">${store.name}</h3>
                    <p style="margin:0; color:#666;">${store.region} | 매장 ID: ${store.id}</p>
                `;
                contentDiv.classList.add('active');

                // 상품 목록 불러오기
                loadProductList();

            } catch (e) {
                console.error(e);
                alert('초기화 중 오류 발생');
            }
        }

        // 2. 상품 목록 조회 함수
        async function loadProductList() {
            if (!myStoreId) return;
            const tbody = document.getElementById('productListBody');
            
            try {
                // 기존 상세 조회 API 재활용 (/api/stores/{id}/detail)
                const res = await fetch(`/api/stores/${myStoreId}/detail`);
                const data = await res.json();
                
                tbody.innerHTML = ''; // 초기화

                if (!data.products || data.products.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="empty-msg">등록된 상품이 없습니다.</td></tr>`;
                    return;
                }

                // 목록 렌더링
                data.products.forEach(prod => {
                    const row = document.createElement('tr');
                    const formattedPrice = prod.price.toLocaleString() + '원';
                    
                    row.innerHTML = `
                        <td><img src="${prod.imageUrl}" class="prod-thumb" alt="상품"></td>
                        <td style="font-weight:500;">${prod.name}</td>
                        <td>${formattedPrice}</td>
                        <td>
                            <button class="btn-delete" onclick="deleteProduct(${prod.id})">삭제</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="4" class="empty-msg" style="color:red;">목록 로딩 실패</td></tr>`;
            }
        }

        // 3. 상품 삭제 함수
        async function deleteProduct(productId) {
            if (!confirm("정말 이 상품을 삭제하시겠습니까?")) return;

            try {
                const res = await fetch(`/api/products/${productId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    alert("삭제되었습니다.");
                    loadProductList(); // 목록 새로고침
                } else {
                    const msg = await res.text();
                    alert("삭제 실패: " + msg);
                }
            } catch (e) {
                alert("서버 연결 오류");
            }
        }

        // 4. 상품 등록 제출
        async function submitProduct() {
            if (!myStoreId) return;
            
            const name = document.getElementById('prodName').value;
            const price = document.getElementById('prodPrice').value;
            const fileInput = document.getElementById('prodImage');
            
            if (!name || !price || fileInput.files.length === 0) {
                return alert("모든 정보를 입력해주세요.");
            }

            const formData = new FormData();
            formData.append("name", name);
            formData.append("price", price);
            formData.append("image", fileInput.files[0]);

            try {
                const res = await fetch(`/api/stores/${myStoreId}/products`, {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    alert("상품이 등록되었습니다!");
                    // 폼 초기화
                    document.getElementById('prodName').value = '';
                    document.getElementById('prodPrice').value = '';
                    document.getElementById('prodImage').value = '';
                    document.getElementById('imgPreview').style.display = 'none';
                    
                    // 목록 새로고침
                    loadProductList();
                } else {
                    alert("등록 실패");
                }
            } catch (e) {
                console.error(e);
                alert("오류 발생");
            }
        }

        // 이미지 미리보기 로직
        document.getElementById('prodImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imgPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // 시작
        initManage();
    </script>
</body>
</html>