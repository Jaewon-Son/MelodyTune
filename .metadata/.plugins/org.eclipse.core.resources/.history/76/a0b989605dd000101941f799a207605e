package com.melodytune.backend.config;

import com.melodytune.backend.domain.Store;
import com.melodytune.backend.domain.Member;
import com.melodytune.backend.domain.Product;
import com.melodytune.backend.domain.Role;
import com.melodytune.backend.domain.Review;
import com.melodytune.backend.repository.StoreRepository;
import com.melodytune.backend.repository.MemberRepository;
import com.melodytune.backend.repository.ProductRepository;
import com.melodytune.backend.repository.ReviewRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

@Configuration
@RequiredArgsConstructor
public class DataInitConfig {

    private final StoreRepository storeRepository;
    private final MemberRepository memberRepository;
    private final ReviewRepository reviewRepository;
    private final ProductRepository productRepository;

    @Bean
    public CommandLineRunner dataLoader() {
        return args -> {
            // DB가 비어있을 때만 실행 (Store 기준으로 확인)
            if (storeRepository.count() == 0) {
                
                // 1. 사용자 생성
                List<Member> members = new ArrayList<>();
                for (int i = 1; i <= 20; i++) {
                    members.add(memberRepository.save(Member.builder() 
                            .name("유저" + i)
                            .email("user" + i + "@test.com")
                            .password("{noop}1234") 
                            .role(Role.USER).build()));
                }
                
                // 리뷰 작성자 지정용 (코드 편의상)
                Member member1 = members.get(0);
                Member member2 = members.get(1);
                Member member3 = members.get(2);

                // 2. 업체 생성 (Store.java 변경 사항 반영: 상세 정보, 이미지 URL 추가 필요)
                Store storeCheonan = storeRepository.save(Store.builder()
                        .name("천안악기랜드")
                        .region("천안시")
                        .lat(36.8175).lng(127.1511)
                        .instruments(Set.of("기타", "피아노", "관현악기", "드럼"))
                        .averageRating(4.1)
                        .totalReviews(20L)
                        .address("충남 천안시 동남구 먹거리10길 23")
                        .phoneNumber("041-555-1234")
                        .operatingHours("10:00 ~ 20:00 (연중무휴)")
                        .description("천안 최대 규모의 종합 악기점입니다.")
                        .build());
                        
                Store storeKeaton = storeRepository.save(Store.builder()
                        .name("키튼 기타")
                        .region("천안시")
                        .lat(36.8218).lng(127.1598)
                        .instruments(Set.of("일렉 기타", "어쿠스틱 기타"))
                        .averageRating(0.0)
                        .totalReviews(20L)
                        .address("충남 천안시 동남구 터미널6길 21")
                        .phoneNumber("041-345-1334")
                        .operatingHours("11:30 ~ 20:00 (연중무휴)")
                        .description("기타 전문점")
                        .build());

                Store storeMusic = storeRepository.save(Store.builder()
                        .name("뮤직센터")
                        .region("천안시")
                        .lat(36.8172).lng(127.1514)
                        .instruments(Set.of("어쿠스틱 기타", "드럼"))
                        .averageRating(0.0)
                        .totalReviews(20L)
                        .address("충남 천안시 동남구 대흥로 334")
                        .phoneNumber("041-345-1334")
                        .operatingHours("10:00 ~ 20:00 (연중무휴)")
                        .description("음악관련 모든 제품을 취급하는 온, 오프라인 쇼핑몰")
                        .build());
                // 상품 더미데이터 생성
                productRepository.saveAll(List.of(
                    Product.builder().store(storeCheonan).name("야마하 퍼시피카 112J").price(380000)
                            .imageUrl("/images/product_yamaha.jpg").build(),
                    Product.builder().store(storeCheonan).name("콜트 G250").price(450000)
                            .imageUrl("/images/product_cort.jpg").build(),
                    Product.builder().store(storeKeaton).name("빈티지 펜더 텔레캐스터").price(7500000)
                            .imageUrl("/images/prod_tele.jpg").build()
                ));
                
                System.out.println("✅ 상품 데이터 초기화 완료!");
                        
                // 4. 리뷰 더미데이터 생성
                List<Review> allReviews = new ArrayList<>();
                String[] cheonanTexts = {
                    "매장이 정말 넓고 다양한 악기가 있어서 구경하는 재미가 있었어요.", "사장님이 친절하시고 설명도 자세하게 해주셔서 좋았습니다.", "주차 공간이 넉넉해서 차 가져가기 너무 편했어요.",
                    "아이 바이올린 사러 갔는데 가격이 합리적이라 만족합니다.", "수리 맡겼는데 수리가 꼼꼼하고 빨라서 놀랐습니다.", "직원분이 좀 바빠 보여서 응대가 늦은 건 아쉬워요.",
                    "A/S 보장이 확실해서 여기서 샀어요. 나중에 문제 생겨도 안심될 듯.", "천안에서 제일 큰 악기점이라 믿고 갑니다. 단골 예약이에요."
                };
                double[] cheonanRatings = {5.0, 5.0, 5.0, 5.0, 5.0, 3.0, 4.5, 4.5};
                addReviews(allReviews, storeCheonan, members, cheonanTexts, cheonanRatings);

                String[] keatonTexts = {
                    "사장님이 기타에 진심이신 분입니다. 전문 지식이 엄청나요.", "기타 셋업 실력은 전국 최고 수준입니다. 버징이 싹 사라졌어요.", "사장님이 조금 무뚝뚝하시긴 한데 실력은 진짜 확실합니다.",
                    "초보자가 가기에는 분위기가 조금 무거울 수 있어요.", "기타 수리하러 갔는데 새 악기처럼 만들어주셨어요. 감동입니다.", "가격은 비싸지만 그만큼 돈값을 하는 세팅입니다."
                };
                double[] keatonRatings = {5.0, 5.0, 4.0, 3.0, 5.0, 4.0};
                addReviews(allReviews, storeKeaton, members, keatonTexts, keatonRatings);

                String[] musicTexts = {
                    "드럼 스틱이 급해서 샀는데 종류별로 다 있어서 좋았어요.", "사장님이 동네 아저씨처럼 푸근하고 정말 친절하십니다.", "가격이 인터넷이랑 비교해도 차이 안 날 정도로 저렴해요.",
                    "입문용 통기타 샀는데 사은품을 이것저것 많이 챙겨주셨어요.", "매장은 작지만 있을 건 다 있습니다. 알짜배기 가게예요.", "주차가 조금 불편한 게 단점이네요. 골목에 대야 해요."
                };
                double[] musicRatings = {5.0, 5.0, 5.0, 5.0, 4.5, 3.0};
                addReviews(allReviews, storeMusic, members, musicTexts, musicRatings);
                
                reviewRepository.saveAll(allReviews);

                System.out.println("초기 더미 데이터 (Store, Member, Review)가 DB에 저장되었습니다!");
            }
        };
    }
    
    // 헬퍼 메서드는 그대로 유지
    private void addReviews(List<Review> allReviews, Store store, List<Member> members, String[] texts, double[] ratings) {
        for (int i = 0; i < texts.length; i++) {
            Member writer = members.get(i % members.size());
            allReviews.add(Review.builder()
                    .store(store)
                    .member(writer)
                    .rating(ratings[i])
                    .content(texts[i])
                    .build());
        }
    }
}