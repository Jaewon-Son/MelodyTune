<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>매장 관리 - Melody Tune</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* 관리 페이지 전용 간단 스타일 */
        body { background: #f5f5f5; overflow: auto; } /* 메인과 달리 스크롤 허용 */
        .manage-container {
            max-width: 800px; margin: 40px auto; background: white;
            padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .page-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #333; }
        
        .status-box {
            padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee;
            text-align: center; margin-bottom: 30px;
        }
        .no-store-msg { color: #666; margin-bottom: 15px; }
        
        /* 상품 등록 폼 */
        .product-form { display: none; flex-direction: column; gap: 15px; }
        .product-form.active { display: flex; }
        
        .form-group label { font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .btn-primary {
            background: #42d29e; color: white; padding: 12px; border-radius: 5px;
            font-weight: bold; font-size: 16px; transition: 0.2s;
        }
        .btn-primary:hover { background: #33b585; }
        
        .preview-img { width: 100%; max-width: 200px; margin-top: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.href='main.html'">Melody Tune</div>
        <div class="center-group"></div> <div class="user-menu">
            <span onclick="location.href='main.html'">메인으로</span>
        </div>
    </header>

    <div class="manage-container">
        <h2 class="page-title">매장 관리</h2>

        <div id="storeStatusBox" class="status-box">
            <p>매장 정보를 불러오는 중...</p>
        </div>

        <div id="addProductSection" class="product-form">
            <h3 style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px;">상품 등록</h3>
            
            <div class="form-group">
                <label>상품 이름</label>
                <input type="text" id="prodName" placeholder="예: 야마하 기타">
            </div>

            <div class="form-group">
                <label>가격 (원)</label>
                <input type="number" id="prodPrice" placeholder="숫자만 입력">
            </div>

            <div class="form-group">
                <label>상품 이미지</label>
                <input type="file" id="prodImage" accept="image/*">
                <img id="imgPreview" class="preview-img" alt="미리보기">
            </div>

            <button class="btn-primary" onclick="submitProduct()">상품 등록하기</button>
        </div>
    </div>

    <script>
        let myStoreId = null;

        // 1. 초기화: 내 매장 정보 가져오기
        async function initManage() {
            try {
                // app.js의 APIService 로직과 유사하지만 간단히 fetch 직접 사용
                const response = await fetch('/api/my-store');
                
                const statusBox = document.getElementById('storeStatusBox');
                const formSection = document.getElementById('addProductSection');

                if (response.status === 204) {
                    // 매장 없음
                    statusBox.innerHTML = `
                        <p class="no-store-msg">아직 등록된 매장이 없습니다.</p>
                        <p style="font-size:13px; color:#999;">메인 페이지의 지도에서 '+ 업체 등록' 버튼을 눌러 매장을 등록해주세요.</p>
                        <button class="btn-primary" onclick="location.href='main.html'" style="background:#333; width:auto; padding:10px 20px;">매장 등록하러 가기</button>
                    `;
                    formSection.classList.remove('active');
                } else if (response.ok) {
                    // 매장 있음
                    const store = await response.json();
                    myStoreId = store.id;
                    
                    statusBox.innerHTML = `
                        <h3 style="margin-bottom:5px; color:#42d29e;">${store.name}</h3>
                        <p style="color:#666;">${store.region} | ID: ${store.id}</p>
                    `;
                    statusBox.style.textAlign = 'left';
                    statusBox.style.borderLeft = '5px solid #42d29e';
                    
                    formSection.classList.add('active'); // 등록 폼 보이기
                } else {
                    alert('로그인이 필요합니다.');
                    location.href = 'login.html';
                }
            } catch (e) {
                console.error(e);
                alert('오류가 발생했습니다.');
            }
        }

        // 2. 이미지 미리보기
        document.getElementById('prodImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imgPreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });

        // 3. 상품 등록 제출
        async function submitProduct() {
            if (!myStoreId) return alert("매장 정보가 없습니다.");
            
            const name = document.getElementById('prodName').value;
            const price = document.getElementById('prodPrice').value;
            const fileInput = document.getElementById('prodImage');
            
            if (!name || !price || fileInput.files.length === 0) {
                return alert("모든 정보를 입력해주세요.");
            }

            // 파일 전송을 위해 FormData 사용
            const formData = new FormData();
            formData.append("name", name);
            formData.append("price", price);
            formData.append("image", fileInput.files[0]);

            try {
                const res = await fetch(`/api/stores/${myStoreId}/products`, {
                    method: 'POST',
                    body: formData // Content-Type은 자동으로 설정됨 (multipart/form-data)
                });

                if (res.ok) {
                    alert("상품이 등록되었습니다!");
                    location.reload(); // 새로고침
                } else {
                    alert("등록 실패: " + await res.text());
                }
            } catch (e) {
                console.error(e);
                alert("서버 연결 실패");
            }
        }

        // 페이지 로드 시 실행
        initManage();
    </script>
</body>
</html>